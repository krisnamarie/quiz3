/*jshint strict:true node:true es5:true onevar:true laxcomma:true laxbreak:true eqeqeq:true immed:true latedef:true*/
(function () {
  "use strict";

  var fs = require('fs')
    , exec = require('child_process').exec
    ;

  function parse(txt) {
    //              total       used       free     shared    buffers     cached
    // Mem:       3064032    1356964    1707068          0     237064     630108
    txt = txt.split('\n')[1];
    txt = /\s+(\d+)\s+(\d+)\s+(\d+)\s+(\d+)\s+(\d+)\s+(\d+)/.exec(txt);
    txt = {
        total: Number(txt[1])
      , used: Number(txt[2])
      , free: Number(txt[3])
      , shared: Number(txt[4])
      , buffers: Number(txt[5])
      , cached: Number(txt[6])
    };

    return txt;
  }

  function free(cb) {
    exec('free', function (err, stdout, stderr) {
      if (err || stderr) {
        cb(err || new Error(__filename + '\n' + stderr));
        return;
      }

      cb(null, parse(stdout));
    });
  }

  if (require.main === module) {
    free(function (err, mstat) {
      if (err) {
        console.error(err);
        return;
      }
      console.log(mstat);
    });
  }

  module.exports.parse = parse;
  module.exports.free = free;
}());
